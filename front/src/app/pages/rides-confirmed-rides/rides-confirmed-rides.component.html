<div class="header bg-gradient-skyblue p-3 pb-7 pt-7">
  <div class="container-fluid">
    <div class="header">
      <h1>Confirmed Rides</h1>

    </div>
  </div>
</div>
<ng-template #content let-modal>
  <div class="bg-aliceblue modal-div">
    <div class="modal-header">
      <h4>Service Type</h4>
      <button
        type="button"
        class="close"
        aria-label="Close"
        (click)="modal.dismiss('Cross click')"
      >
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="modal-body text-center">
      <label for="status">Filter by status:</label>
      <select id="status">
        <option value="">All</option>
        <option value="accepted">Accepted</option>
        <option value="arrived">Arrived</option>
        <option value="picked">Picked</option>
        <option value="started">Started</option>
        <option value="completed">Completed</option>
      </select>
      <label for="vehicle">Filter by vehicle:</label>
      <select id="vehicle">
        <option value="">All</option>
        <option value="car">Car</option>
        <option value="motorcycle">Motorcycle</option>
        <option value="scooter">Scooter</option>
        <option value="bicycle">Bicycle</option>
      </select>
      <label for="search" class="form-label">Search:</label>
      <input
        type="text"
        id="search"
        class="form-control"
        placeholder="Username, phone number, request ID..."
      />
      <label for="from-date" class="form-label">From:</label>
      <input type="date" id="from-date" class="form-control" />
      <label for="to-date" class="form-label">To:</label>
      <input type="date" id="to-date" class="form-control" />
      <button type="submit" class="btn btn-primary mt-3">Apply Filters</button>
    </div>

    <!--
    <div class="modal-footer">
      <button type="button" class="btn btn-info" (click)="updateService(vehicle.value)">Save Updates</button>
      <button type="button" class="btn btn-danger" (click)="modal.close('Close click')">Delete Service</button>
    </div> -->
  </div>
</ng-template>
<ng-template #content5 let-modal>
  <div class="bg-aliceblue modal-div">
    <div class="modal-header">
      <h4>Service Type</h4>
      <button
        type="button"
        class="close"
        aria-label="Close"
        (click)="modal.dismiss('Cross click')"
      >
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="modal-body text-center">

      <form           [formGroup]="feedBackForm"
      >

      <label id="lbl">FeedBack :</label>
      <textarea name="feedback" id="feedback" formControlName="feedback" rows="10"></textarea>

      <button type="button" class="btn btn-primary" (click)="submitFeedBack(modal);">Submit</button>
      <button class="btn btn-danger" (click)="modal.close('Close click')">Cancel</button>
    </form>




    </div>

    <!--
    <div class="modal-footer">
      <button type="button" class="btn btn-info" (click)="updateService(vehicle.value)">Save Updates</button>
      <button type="button" class="btn btn-danger" (click)="modal.close('Close click')">Delete Service</button>
    </div> -->
  </div>
</ng-template>





<div class="container-fluid mt--5">
  <!-- Table -->
  <div class="row">
    <div class="col">
      <div class="card shadow">
        <div class="card-header border-0 row mr-0 ml-0">
          <select
            class="form-control col-sm-1"
            name="search_type"
            id="search_type"
          >
            <option value="_id" selected>Ride Id</option>
            <option value="user.name">User</option>
            <option value="user.mobile">Phone Number</option>
            <option value="pickup">Pickup</option>
            <option value="dropoff">Dropoff</option>
            <option value="vehicle.name">Vehicle</option>
          </select>
          <select
            class="form-control col-sm-1"
            name="payment_mode"
            id="payment_mode"
          >
            <option value="" selected>All</option>
            <option value="0">Cash</option>
            <option value="1">Card</option>
          </select>
          <select class="form-control col-sm-1" name="status" id="status">
            <option value= '' selected>All</option>
            <option value="0" >Pending</option>
            <option value="2">Accepted</option>
            <option value="3">Arrived</option>
            <option value="4">Picked</option>
            <option value="5">Started</option>
          </select>
          <input
            type="search"
            name="search_value"
            id="search_value"
            class="form-control col-sm-2"
            placeholder="Search"
            #search
          />
          <input
            class="col-sm-1 form-control"
            type="date"
            name="from_date"
            id="from_date"
          />
          <input
            class="col-sm-1 form-control"
            type="date"
            name="to_date"
            id="to_date"
          />
          <div class="btn-group col-sm-1">
            <button class="btn" type="submit" (click)="onSearch(search.value)">
              <i class="search-icon fas fa-search"></i>
            </button>
            <button
              class="btn refresh"
              (click)="showRides(1); search.value = ''"
            >
              ‚ü≥
            </button>
          </div>
          <div class="col-sm-4 text-right">
            <button
              class="btn btn-outline-primary"
              type="button"
              (click)="onDownload()"
            >
              Download
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table text-center">
            <thead class="thead-light">
              <tr>
                <th>Request ID</th>
                <th>User Name</th>
                <th>Driver ID</th>
                <th>Service Type</th>
                <th>Status</th>
                <th>Payment</th>
                <th>create time</th>
                <th>Action</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <!-- Use a loop to display all the requests with their details -->
              <!-- <tr *ngFor="let ride of ridesArray" (click)="openModel(content2)"> -->
              <tr *ngFor="let ride of ridesArray">
                <ng-template #content2 let-modal>
                  <div class="bg-aliceblue modal-div">
                    <div class="modal-header">
                      <h4>Service Type</h4>
                      <button
                        type="button"
                        class="close"
                        aria-label="Close"
                        (click)="modal.dismiss('Cross click')"
                      >
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>

                    <div class="modal-body">
                      <div>User Name : {{ ride.user.name }}</div>
                      <div>Pick Up : {{ ride.picked }}</div>
                      <div>dropp off : {{ ride.dropoff }}</div>
                      <div>No. Stops : {{ ride.stop.length }}</div>
                      <div>Vehicle: {{ ride.vehicle.name }}</div>
                      <div>Status : {{ ride.status }}</div>
                      <div>Creat Time : {{ ride.createdAt | utcDate }}</div>
                      <div>Assign Type : {{ ride.assignType || "--" }}</div>
                      <div>Distance : {{ ride.distance }}</div>
                    </div>
                  </div>
                </ng-template>

                <td>{{ ride._id || "--" }}</td>
                <td>{{ ride.user.name || "--" }}</td>
                <td *ngIf="ride.driver">{{ ride?.driver[0]?.name || "--" }}</td>
                <td *ngIf="!ride.driver">{{  "--" }}</td>
                <td>{{ ride.vehicle.name || "--" }}</td>
                <td>
                  <span
                    [ngClass]="{
                      'badge badge-pill badge-success':
                        ride.status === 2,
                      'badge badge-pill badge-warning':
                        ride.status === 'processing',
                      'badge badge-pill badge-primary':
                        ride.status === 'assigning',
                      'badge badge-pill badge-dark': ride.status === 0
                    }"
                    id="s{{ ride._id }}"
                    >{{ ride.status | rideStatus }}</span
                  >
                </td>
                <td>{{ ride.payment_type | paymentType }}</td>
                <td>{{ ride.createdAt || "--" | utcDate }}</td>
                <td>
                  <!-- If a driver is not assigned, show a button to assign one -->
                  <button
                    class="btn btn btn-primary"
                    id="b{{ ride._id }}"
                    *ngIf="ride.status == 0 && !ride.assignType"
                    (click)="openModel(content3,ride)"
                  >
                    Assign
                  </button>
                  <button
                    class="btn btn btn-success"
                    id="b{{ ride._id }}"
                    *ngIf="ride.status >= 2"
                    (click)="StatusNext(ride,content5)"
                  >
                    Next
                  </button>
                  <button
                    class="btn btn btn-primary"
                    id="b{{ ride._id }}"
                    *ngIf="ride.status == 0 && ride.assignType == 4"
                    (click)="openModel(content3,ride)"

                  >
                    Reassign
                  </button>

                  <ng-template #content3 let-modal>
                    <div class="bg-aliceblue modal-div">
                      <div class="modal-header">
                        <h4>Service Type</h4>
                        <button
                          type="button"
                          class="close"
                          aria-label="Close"
                          (click)="modal.dismiss('Cross click')"
                        >
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>

                      <div class="modal-body">
                        <p><strong>Trip Details:</strong></p>

                        <div>Pick Up : {{ ride.pickup }}</div>
                        <div>Drop Off : {{ ride.dropoff }}</div>
                        <div>Vehicle : {{ ride.vehicle.name }}</div>
                        <div>Time : {{ ride.time }}</div>
                        <div>Distance : {{ ride.distance }}</div>
                        <div>paymentType : {{ ride.payment_type | paymentModes }}</div>
                        <div> Stops : {{ride.stop.length}}</div>

                        <p>
                          <strong>Booking Time:</strong> {{ ride.bookingtime |utcDate }}
                        </p>
                        <!-- <p>
                          <strong>Schedule Time:</strong> [insert schedule time
                          here]
                        </p> -->
                        <p><strong>Available Drivers:</strong></p>
                        <table class="table table-striped text-center">
                          <thead>
                            <tr>
                              <th class="text-wrap">Driver ID</th>
                              <th>Name</th>
                              <th>Phone</th>
                              <th>Email</th>
                            </tr>
                          </thead>
                          <tbody>
                            <!-- <input type="radio" name="driver" value="{{driver._id}}" > -->

                            <tr
                              *ngFor="let driver of OnlineDrivers"
                              (click)="onRowClick(driver)"
                              [class.table-primary]="driver === selectedDriver"
                            >
                              <td>{{ driver._id }}</td>
                              <td>{{ driver.name }}</td>
                              <td>{{ driver.mobile }}</td>
                              <td>{{ driver.email }}</td>
                            </tr>
                            <tr class="text-center"  *ngIf="OnlineDrivers.length == 0" > <td colspan="4">Driver's Not Found</td></tr>
                          </tbody>
                        </table>

                        <div class="modal-footer">
                          <button
                          *ngIf="OnlineDrivers.length >0"
                            type="button"
                            class="btn btn-info"
                            id="assign-selected-driver"
                            (click)="
                              onSelectAssign(ride, selectedDriver,modal);
                            "
                          >
                            Assign Selected Driver
                          </button>
                          <button
                          *ngIf="OnlineDrivers.length >0"

                            type="button"
                            class="btn btn-secondary "
                            id="assign-nearest-driver"

                            (click)="
                              onAutoAssign(ride); modal.close('Close click')
                            "
                          >
                            Assign Nearest Driver
                          </button>
                          <button class="btn btn-danger" (click)=" modal.close('Close click')">Cancel</button>
                          <span id="randomButton"  *ngIf="OnlineDrivers.length == 0" (mouseenter)="moveButton()" class="btn btn-secondary"> Assign Driver</span>


                        </div>
                      </div>
                    </div>
                  </ng-template>

                  <!--
                  <div class="modal" id="{{ride._id}}">
                    <div class="modal-dialog custom-modal-dialog" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Assign Driver</h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                            (click)="closeAssignDialog(ride._id)">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">

                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-primary" id="assign-selected-driver"
                            (click)="onSelectAssign(ride,selectedDriver);closeAssignDialog(ride._id)">Assign Selected
                            Driver</button>
                          <button type="button" class="btn btn-secondary" id="assign-nearest-driver"
                            (click)="onAutoAssign(ride);closeAssignDialog(ride._id)">Assign Nearest
                            Driver</button>
                        </div>
                      </div>
                    </div>
                  </div> -->

                  <!-- If the request is not accepted, show a button to cancel it -->
                  <button
                    class="btn btn-danger"
                    *ngIf="ride.status !== 'cancelled'"
                    (click)="onCancel(ride._id)"
                  >
                    Cancel
                  </button>
                </td>
                <td ><img (click)="openModel(content4,ride,{readOnly:true})" src="../../../assets/img/icons/info.png" width="23rem" height="23rem" alt=""></td>
              </tr>
              <tr *ngIf="ridesArray?.length <= 0">
                <td class="Empty p-5" colspan="8">
                  <strong> Rides Not Found</strong>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="card-footer py-4" *ngIf="ridesArray?.length>0">
          <nav aria-label="...">
            <ul class="pagination justify-content-end mb-0">
              <li
                class="page-item disabled"
                *ngIf="currentPage !== 1"
                (click)="onPrevious()"
              >
                <a class="page-link">
                  <i class="fas fa-angle-left"></i>
                  <span class="sr-only">Previous</span>
                </a>
              </li>
              <li
                class="page-item"
                [ngClass]="{ active: currentPage == i + 1 }"
                [hidden]="currentPage < i || currentPage - 1 > i + 1"
                *ngFor="let item of NoOfPages; let i = index"
              >
                <a class="page-link" (click)="onPage(i + 1)">{{ i + 1 }}</a>
              </li>

              <li
                class="page-item"
                [ngClass]="{ vh: currentPage == NoOfPages?.length }"
                (click)="onNext()"
              >
                <a class="page-link">
                  <i class="fas fa-angle-right"></i>
                  <span class="sr-only">Next</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <!-- Dark table -->
</div>
<ng-template #content4 let-modal>
  <div class="bg-aliceblue modal-div">
    <div class="modal-header">
      <h3>Ride Details</h3>
      <button
        type="button"
        class="close"
        aria-label="Close"
        (click)="modal.dismiss('Cross click')"
      >
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="modal-body row ml-0 mr-0 text-left align-middle">
      <div class="col-sm-3">Ride ID</div>
      <div class="col-sm-1">:</div>
      <div class="col-sm-8">{{ rideInfo._id }}</div>
      <div class="col-sm-3">User</div>
      <div class="col-sm-1">:</div>
      <div class="col-sm-8">{{ rideInfo.user.name }}</div>
      <div class="col-sm-3">Pickup Location</div>
      <div class="col-sm-1">:</div>
      <div class="col-sm-8">{{ rideInfo.pickup }}</div>
      <div class="col-sm-3">DropOff Location</div>
      <div class="col-sm-1">:</div>
      <div class="col-sm-8">{{ rideInfo.dropoff}}</div>
      <div class="col-sm-3">Vehicle</div>
      <div class="col-sm-1">:</div>
      <div class="col-sm-8">{{ rideInfo.vehicle.name }}</div>
      <div class="col-sm-3">Payment Type</div>
      <div class="col-sm-1">:</div>
      <div class="col-sm-8">{{ rideInfo.payment_type | paymentType}}</div>
      <div *ngIf="rideInfo.scheduledate" class="col-sm-3">Schedule Time</div>
      <div *ngIf="rideInfo.scheduledate" class="col-sm-1">:</div>
      <div *ngIf="rideInfo.scheduledate"  class="col-sm-8">{{ rideInfo.scheduledate }}{{scheduletime}}</div>
      <div  class="col-sm-3" *ngIf="rideInfo.stop.length >0">Stops</div>
      <div class="col-sm-1" *ngIf="rideInfo.stop.length >0">:</div>
      <div class="col-sm-8" *ngIf="rideInfo.stop.length >0">

          <div class="mt-3 mb-3" *ngFor="let stp of rideInfo.stop; let i = index"> {{ i+1 }}.  {{ stp }}</div>
      </div>
      <!-- <div>{{rideInfo.stop}}</div> -->
      <div  class="col-sm-3">Booking Time</div>
      <div class="col-sm-1">:</div>
      <div class="col-sm-8">{{ rideInfo.createdAt | utcDate }}</div>
      <div class="col-sm-3">Total Distance</div>
      <div class="col-sm-1">:</div>
      <div class="col-sm-8">{{ rideInfo.distance }} km</div>
      <div class="col-sm-3">Total Time</div>
      <div class="col-sm-1">:</div>
      <div class="col-sm-8">{{ rideInfo.time }} min</div>
      <div class="col-sm-3">Ride Fees</div>
      <div class="col-sm-1">:</div>
      <div class="col-sm-8"> Rs. {{ rideInfo.ride_fees }} </div>
      <div class="col-sm-3">Status</div>
      <div class="col-sm-1">:</div>
      <div class="col-sm-8">{{ rideInfo.status | rideStatus}}</div>
      <div id="map"></div>
    </div>
  </div>
</ng-template>
